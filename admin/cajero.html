<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta | Huellitas Digitales</title>
    <link rel="icon" type="image/png" href="../assets/img/favicon.png">
    <style>
        :root { --primary: #2bb673; --error: #e74c3c; --dark: #2c3e50; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 400px; }
        
        .btn-back { display: inline-flex; align-items: center; text-decoration: none; color: #666; font-size: 14px; margin-bottom: 20px; font-weight: bold; transition: 0.2s; }
        .btn-back:hover { color: var(--primary); }

        h2 { margin: 0 0 10px 0; color: var(--dark); }
        p { color: #777; font-size: 14px; margin-bottom: 25px; line-height: 1.4; }

        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-size: 12px; font-weight: bold; color: #555; text-transform: uppercase; letter-spacing: 1px; }
        input { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 12px; font-size: 20px; box-sizing: border-box; text-transform: uppercase; text-align: center; font-family: monospace; transition: 0.3s; }
        input:focus { border-color: var(--primary); outline: none; background: #f0fff4; }

        .btn-activate { width: 100%; background: var(--primary); color: white; border: none; padding: 18px; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; box-shadow: 0 6px 15px rgba(43,182,115,0.3); transition: 0.3s; }
        .btn-activate:active { transform: scale(0.98); }
        .btn-activate:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

        #mensaje { margin-top: 20px; padding: 15px; border-radius: 12px; display: none; text-align: center; font-size: 14px; line-height: 1.4; }
        .success { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; display: block !important; }
        .error { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; display: block !important; }

        .footer-info { margin-top: 30px; text-align: center; font-size: 11px; color: #bbb; border-top: 1px solid #eee; padding-top: 15px; }
    </style>
</head>
<body>

<div class="card">
    <a href="../admin.html" class="btn-back">‚¨ÖÔ∏è Panel Principal</a>

    <img src="../assets/img/logo.png" alt="Huellitas" style="width: 50px; margin-bottom: 15px;">
    <h2>Cajero: Habilitar Venta</h2>
    <p>Escanea o escribe el ID de la placa para permitir que el cliente pueda registrar a su mascota.</p>

    <div class="input-group">
        <label for="placaId">ID de Placa (6 caracteres)</label>
        <input type="text" id="placaId" placeholder="ABC123" maxlength="6" autocomplete="off">
    </div>

    <button id="btnActivar" class="btn-activate">‚úÖ Habilitar para Venta</button>

    <div id="mensaje"></div>

    <div class="footer-info">
        <b>SISTEMA DE SEGURIDAD ACTIVO</b><br>
        Las placas activas o ya vendidas no pueden procesarse dos veces.
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCqROIzmp2guo2XLbdYrSW3ujlUBc7ngOc",
        authDomain: "huellitas-digitales.firebaseapp.com",
        projectId: "huellitas-digitales",
        storageBucket: "huellitas-digitales.firebasestorage.app",
        messagingSenderId: "523935942496",
        appId: "1:523935942496:web:0bb3ad3b28c189345fc005"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- CONFIGURACI√ìN DE GOOGLE SHEETS ---
    const URL_SHEETS = "https://script.google.com/macros/s/AKfycbzH1tsICupT_eLE1aNzsUMUx_0w3Wl6ZcAckHGmtuvXLmuOBKg2kBHf285e1DVGY6iVSA/exec"; 

    const inputPlaca = document.getElementById("placaId");
    const btnActivar = document.getElementById("btnActivar");
    const mensaje = document.getElementById("mensaje");

    btnActivar.addEventListener("click", async () => {
        const id = inputPlaca.value.toUpperCase().trim();
        
        if (id.length < 6) {
            mostrarMensaje("‚ùå El ID debe tener exactamente 6 caracteres.", "error");
            return;
        }

        btnActivar.disabled = true;
        btnActivar.innerText = "Verificando estado...";
        mensaje.style.display = "none";

        try {
            const docRef = doc(db, "placas", id);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();

                if (data.activa === true) {
                    mostrarMensaje(`üö´ BLOQUEADO: La placa ${id} ya est√° activa y vinculada a la mascota "${data.mascota.toUpperCase()}". No se puede re-habilitar.`, "error");
                    resetBtn();
                    return;
                }

                if (data.vendida === true) {
                    const fecha = data.fechaVenta ? new Date(data.fechaVenta).toLocaleDateString() : "desconocida";
                    mostrarMensaje(`‚ö†Ô∏è AVISO: Esta placa ya fue habilitada en caja el d√≠a ${fecha}. Est√° lista para que el cliente la use.`, "error");
                    resetBtn();
                    return;
                }

                await updateDoc(docRef, {
                    activa: false,
                    vendida: true,
                    fechaVenta: new Date().toISOString()
                });

                // --- ACTUALIZAR GOOGLE SHEETS ---
                fetch(URL_SHEETS, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        id: id,
                        status: "VENDIDA"
                    }),
                    headers: { 'Content-Type': 'application/json' }
                }).catch(e => console.log("Error Sheets:", e));
                // --------------------------------

                mostrarMensaje(`‚úÖ √âXITO: Placa ${id} habilitada. El cliente ya puede registrar a su mascota.`, "success");
                inputPlaca.value = ""; 
            } else {
                mostrarMensaje("‚ùå ERROR: El ID ingresado no existe en el inventario maestro.", "error");
            }
        } catch (error) {
            console.error("Error Firebase:", error);
            mostrarMensaje("‚ö†Ô∏è Error de conexi√≥n con la base de datos.", "error");
        } finally {
            resetBtn();
        }
    });

    function mostrarMensaje(texto, tipo) {
        mensaje.innerText = texto;
        mensaje.className = tipo;
    }

    function resetBtn() {
        btnActivar.disabled = false;
        btnActivar.innerText = "‚úÖ Habilitar para Venta";
    }
</script>

</body>
</html>
