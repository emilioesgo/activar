<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta | Huellitas Digitales</title>
    <link rel="icon" type="image/png" href="../assets/img/favicon.png">
    <style>
        :root { --primary: #2bb673; --dark: #2c3e50; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 400px; }
        
        /* Botón Volver */
        .btn-back { display: inline-flex; align-items: center; text-decoration: none; color: #666; font-size: 14px; margin-bottom: 20px; font-weight: bold; }
        .btn-back:hover { color: var(--primary); }

        h2 { margin: 0 0 10px 0; color: var(--dark); }
        p { color: #777; font-size: 14px; margin-bottom: 25px; }

        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-size: 13px; font-weight: bold; color: #555; }
        input { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 12px; font-size: 18px; box-sizing: border-box; text-transform: uppercase; transition: 0.3s; }
        input:focus { border-color: var(--primary); outline: none; background: #f0fff4; }

        .btn-activate { width: 100%; background: var(--primary); color: white; border: none; padding: 18px; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; box-shadow: 0 6px 15px rgba(43,182,115,0.3); transition: 0.3s; }
        .btn-activate:active { transform: scale(0.98); }
        .btn-activate:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

        #mensaje { margin-top: 20px; padding: 15px; border-radius: 10px; display: none; text-align: center; font-size: 14px; font-weight: bold; }
        .success { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; display: block !important; }
        .error { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; display: block !important; }

        .footer-info { margin-top: 30px; text-align: center; font-size: 11px; color: #bbb; border-top: 1px solid #eee; padding-top: 15px; }
    </style>
</head>
<body>

<div class="card">
    <a href="../admin.html" class="btn-back">⬅️ Volver al Panel</a>

    <img src="../assets/img/logo.png" alt="Huellitas" style="width: 50px; margin-bottom: 10px;">
    <h2>Habilitar Placa</h2>
    <p>Ingresa el ID de la placa física que el cliente acaba de comprar para activarla en el sistema.</p>

    <div class="input-group">
        <label for="placaId">ID DE LA PLACA (6 caracteres)</label>
        <input type="text" id="placaId" placeholder="EJ: K9W7X2" maxlength="6" autocomplete="off">
    </div>

    <button id="btnActivar" class="btn-activate">✅ Habilitar para Venta</button>

    <div id="mensaje"></div>

    <div class="footer-info">
        <b>MODO CAJERO ACTIVO</b><br>
        Esta acción cambia el estado de la placa de "No activa" a "Pendiente de registro".
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Configuración de Firebase (Asegúrate de que sea la misma de tus otros archivos)
    const firebaseConfig = {
        apiKey: "AIzaSyCqROIzmp2guo2XLbdYrSW3ujlUBc7ngOc",
        authDomain: "huellitas-digitales.firebaseapp.com",
        projectId: "huellitas-digitales",
        storageBucket: "huellitas-digitales.firebasestorage.app",
        messagingSenderId: "523935942496",
        appId: "1:523935942496:web:0bb3ad3b28c189345fc005"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const inputPlaca = document.getElementById("placaId");
    const btnActivar = document.getElementById("btnActivar");
    const mensaje = document.getElementById("mensaje");

    btnActivar.addEventListener("click", async () => {
        const id = inputPlaca.value.toUpperCase().trim();
        
        if (id.length < 6) {
            mostrarMensaje("El ID debe tener 6 caracteres", "error");
            return;
        }

        btnActivar.disabled = true;
        btnActivar.innerText = "Procesando...";
        mensaje.style.display = "none";

        try {
            const docRef = doc(db, "placas", id);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                // Actualizamos el estado de la placa
                await updateDoc(docRef, {
                    activa: false, // Permitimos que el cliente ahora la registre
                    vendida: true,
                    fechaVenta: new Date().toISOString()
                });

                mostrarMensaje(`¡Placa ${id} habilitada con éxito!`, "success");
                inputPlaca.value = ""; // Limpiar para la siguiente venta
            } else {
                mostrarMensaje("Ese ID no existe en el inventario", "error");
            }
        } catch (error) {
            console.error(error);
            mostrarMensaje("Error de conexión con la base de datos", "error");
        } finally {
            btnActivar.disabled = false;
            btnActivar.innerText = "✅ Habilitar para Venta";
        }
    });

    function mostrarMensaje(texto, tipo) {
        mensaje.innerText = texto;
        mensaje.className = tipo;
    }
</script>

</body>
</html>
