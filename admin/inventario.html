<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carga de Inventario | Huellitas Control</title>
    <link rel="icon" type="image/png" href="../assets/img/favicon.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { 
            --primary: #2bb673; 
            --dark-bg: #1a1a1a; 
            --card-bg: #2d2d2d; 
            --text: #eeeeee; 
            --danger: #ff4757; 
            --warning: #ffa502;
        }

        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background: var(--dark-bg); 
            color: var(--text);
            margin: 0; 
            padding: 20px; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            min-height: 100vh;
        }
        
        .card { 
            background: var(--card-bg); 
            padding: 40px; 
            border-radius: 30px; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.4); 
            width: 100%; 
            max-width: 500px; 
            border: 1px solid #444;
        }
        
        .btn-back { 
            display: inline-flex; 
            align-items: center; 
            text-decoration: none; 
            color: #aaa; 
            font-size: 13px; 
            margin-bottom: 20px; 
            transition: 0.3s;
        }
        .btn-back:hover { color: var(--primary); }
        
        h2 { margin: 0 0 5px 0; color: #fff; font-size: 24px; }
        .subtitle { color: #888; font-size: 14px; margin-bottom: 25px; }

        label { 
            display: block; 
            margin-bottom: 10px; 
            font-size: 11px; 
            font-weight: 800; 
            color: var(--primary); 
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        textarea { 
            width: 100%; 
            height: 150px; 
            padding: 15px; 
            border: 1px solid #444; 
            border-radius: 15px; 
            font-family: 'Courier New', monospace; 
            font-size: 16px; 
            box-sizing: border-box; 
            resize: none;
            text-transform: uppercase;
            background: #111;
            color: var(--primary);
            transition: 0.3s;
        }
        textarea:focus { 
            border-color: var(--primary); 
            outline: none; 
            background: #161616;
            box-shadow: 0 0 15px rgba(43, 182, 115, 0.1);
        }

        .btn-save { 
            width: 100%; 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 18px; 
            border-radius: 15px; 
            font-weight: bold; 
            font-size: 16px; 
            cursor: pointer; 
            margin-top: 25px;
            transition: 0.3s; 
            box-shadow: 0 5px 15px rgba(43, 182, 115, 0.2);
        }
        .btn-save:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(43, 182, 115, 0.3); }
        .btn-save:active { transform: scale(0.98); }
        .btn-save:disabled { background: #444; color: #777; cursor: not-allowed; transform: none; }

        #log { 
            margin-top: 25px; 
            max-height: 180px; 
            overflow-y: auto; 
            font-size: 12px; 
            padding: 15px; 
            background: #111; 
            border-radius: 12px; 
            display: none;
            border: 1px solid #333;
            text-align: left;
            font-family: 'Courier New', monospace;
        }
        .log-entry { margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid #222; }
        .success-text { color: var(--primary); }
        .error-text { color: var(--danger); }
        .warning-text { color: var(--warning); }

        .note-box {
            margin-top: 25px; 
            padding: 15px; 
            background: rgba(255, 193, 7, 0.05); 
            border: 1px solid rgba(255, 193, 7, 0.2);
            border-radius: 15px; 
            font-size: 12px; 
            color: #ccc;
            line-height: 1.4;
        }
    </style>
</head>
<body>

<div class="card">
    <a href="../admin.html" class="btn-back"><i class="fas fa-arrow-left"></i> &nbsp; VOLVER AL PANEL</a>
    
    <h2>Carga de Inventario</h2>
    <p class="subtitle">Registra nuevos identificadores en la base de datos central.</p>

    <div class="input-group">
        <label for="listaIds">Listado de IDs (6 caracteres)</label>
        <textarea id="listaIds" placeholder="K9W7X2&#10;BT4M8P&#10;RH9L3Y"></textarea>
    </div>

    <button id="btnGuardar" class="btn-save">游 REGISTRAR PLACAS</button>

    <div id="log"></div>

    <div class="note-box">
        <i class="fas fa-info-circle" style="color:var(--gold)"></i> &nbsp; <b>Nota:</b> El sistema omitir치 autom치ticamente IDs que ya existan. Las placas nuevas quedar치n vinculadas pero inactivas.
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCqROIzmp2guo2XLbdYrSW3ujlUBc7ngOc",
        authDomain: "huellitas-digitales.firebaseapp.com",
        projectId: "huellitas-digitales",
        storageBucket: "huellitas-digitales.firebasestorage.app",
        messagingSenderId: "523935942496",
        appId: "1:523935942496:web:0bb3ad3b28c189345fc005"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const textarea = document.getElementById("listaIds");
    const btnGuardar = document.getElementById("btnGuardar");
    const logDiv = document.getElementById("log");

    btnGuardar.addEventListener("click", async () => {
        const contenido = textarea.value.trim();
        if (!contenido) return alert("Pega algunos IDs primero.");

        const ids = contenido.split(/[\n,]+/).map(id => id.trim().toUpperCase()).filter(id => id.length > 0);
        
        if (!confirm(`쮺onfirmar subida de ${ids.length} placas al sistema de control?`)) return;

        btnGuardar.disabled = true;
        btnGuardar.innerText = "PROCESANDO NUBE...";
        logDiv.style.display = "block";
        logDiv.innerHTML = "<b style='color:#888'>Iniciando comunicaci칩n...</b><br><br>";

        let exitosos = 0;
        let fallidos = 0;

        for (const id of ids) {
            if (id.length !== 6) {
                logDiv.innerHTML += `<div class="log-entry error-text">ERR: ${id} (Formato inv치lido)</div>`;
                fallidos++;
                continue;
            }

            try {
                const docRef = doc(db, "placas", id);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    await setDoc(docRef, {
                        activa: false,
                        vendida: false,
                        mascota: "",
                        telefono: "",
                        foto: "",
                        mensaje: "",
                        pin: ""
                    });
                    logDiv.innerHTML += `<div class="log-entry success-text">OK: ${id} (Registrada)</div>`;
                    exitosos++;
                } else {
                    logDiv.innerHTML += `<div class="log-entry warning-text">SKIP: ${id} (Ya existe)</div>`;
                    fallidos++;
                }
            } catch (e) {
                logDiv.innerHTML += `<div class="log-entry error-text">FAIL: ${id} (Error conexi칩n)</div>`;
                fallidos++;
            }
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        btnGuardar.disabled = false;
        btnGuardar.innerText = "游 REGISTRAR PLACAS";
        alert(`Sincronizaci칩n completa.\nExitosos: ${exitosos}\nOmitidos/Err칩neos: ${fallidos}`);
    });
</script>

</body>
</html>
