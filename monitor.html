<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Monitor | Huellitas Digitales</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #2bb673; --dark: #1a1a1a; --card: #2d2d2d; --text: #eee; --blue: #3498db; }
        
        body { 
            font-family: 'Courier New', monospace; 
            background: var(--dark); color: var(--text); 
            margin: 0; padding: 20px; 
        }

        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px; }
        .live-indicator { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--primary); }
        .dot { width: 10px; height: 10px; background: var(--primary); border-radius: 50%; animation: blink 1s infinite; }
        
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #444; }
        .stat-card h3 { margin: 0; font-size: 11px; color: #888; text-transform: uppercase; }
        .stat-card p { margin: 10px 0 0; font-size: 22px; font-weight: bold; color: var(--primary); }
        .stat-card p.blue { color: var(--blue); }

        .main-layout { display: grid; grid-template-columns: 1.2fr 1fr; gap: 20px; }
        @media (max-width: 900px) { .main-layout { grid-template-columns: 1fr; } }

        .log-container { background: var(--card); border-radius: 15px; overflow: hidden; border: 1px solid #444; height: 500px; display: flex; flex-direction: column; }
        .log-header { background: #333; padding: 10px 20px; font-size: 12px; color: #aaa; display: grid; grid-template-columns: 1fr 2fr 1fr; }
        #log-list { flex: 1; overflow-y: auto; }
        
        .log-entry { 
            padding: 15px 20px; border-bottom: 1px solid #3d3d3d; 
            display: grid; grid-template-columns: 1fr 2fr 1fr; 
            font-size: 13px; transition: 0.3s;
        }
        .new-entry { animation: highlight 2s ease-out; }
        @keyframes highlight { from { background: rgba(43, 182, 115, 0.3); } to { background: transparent; } }

        /* --- NUEVOS ESTILOS PARA HERRAMIENTAS DE INVENTARIO --- */
        .inventory-container { background: var(--card); border-radius: 15px; border: 1px solid #444; padding: 20px; height: 500px; overflow: hidden; display: flex; flex-direction: column; }
        
        .filter-bar { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .filter-btn { 
            background: #333; color: #aaa; border: 1px solid #444; padding: 6px 12px; 
            border-radius: 6px; cursor: pointer; font-size: 10px; font-weight: bold; transition: 0.2s;
            font-family: inherit;
        }
        .filter-btn:hover { background: #444; color: #fff; }
        .filter-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(43, 182, 115, 0.1); }
        .filter-btn.btn-blue.active { border-color: var(--blue); color: var(--blue); background: rgba(52, 152, 219, 0.1); }

        .inventory-tools { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-wrapper { position: relative; flex: 1; }
        .search-wrapper i { position: absolute; left: 12px; top: 12px; color: #666; font-size: 12px; }
        #search-input { 
            width: 100%; background: #111; border: 1px solid #444; padding: 10px 10px 10px 35px; 
            border-radius: 8px; color: var(--primary); font-family: inherit; box-sizing: border-box; font-size: 12px;
        }
        #search-input:focus { outline: none; border-color: var(--primary); }
        
        .btn-export { 
            background: var(--primary); color: #000; border: none; padding: 0 15px; 
            border-radius: 8px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center;
        }
        .btn-export:hover { background: white; transform: scale(1.05); }

        .grid-placas { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; overflow-y: auto; flex: 1; padding-right: 5px; }
        .placa-item { 
            padding: 10px 5px; border-radius: 8px; font-size: 11px; font-weight: bold; text-align: center;
            cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        }
        .p-disponible { background: rgba(43, 182, 115, 0.1); color: var(--primary); border-color: var(--primary); }
        .p-ocupada { background: rgba(52, 152, 219, 0.1); color: var(--blue); border-color: var(--blue); }
        .placa-item:hover { transform: scale(1.05); filter: brightness(1.2); }

        /* MODAL RESUMEN */
        #modal-resumen {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }
        .modal-body {
            background: var(--card); padding: 30px; border-radius: 20px; border: 2px solid var(--blue);
            max-width: 350px; width: 90%; text-align: center; position: relative;
        }
        .modal-body h4 { margin: 0 0 15px; color: var(--blue); text-transform: uppercase; }
        .modal-body p { margin: 8px 0; font-size: 14px; }
        .btn-close { background: var(--blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; margin-top: 20px; cursor: pointer; font-weight: bold; }

        .tag { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .tag-activation { background: #2ecc71; color: #000; }
        .tag-reset { background: #e74c3c; color: #fff; }

        .time { color: #888; text-align: right; }
        .placa-id { color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <h2>HUELLITAS_LIVE_MONITOR v1.0</h2>
        <div class="live-indicator">
            <div class="dot"></div> EN VIVO
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Eventos Hoy</h3>
            <p id="count-today">0</p>
        </div>
        <div class="stat-card">
            <h3>Disponibles</h3>
            <p id="total-disp">0</p>
        </div>
        <div class="stat-card">
            <h3>Ocupadas</h3>
            <p id="total-ocup" class="blue">0</p>
        </div>
    </div>

    <div class="main-layout">
        <div class="log-container">
            <div class="log-header">
                <span>PLACA_ID</span>
                <span>EVENTO / ORIGEN</span>
                <span style="text-align: right;">TIMESTAMP</span>
            </div>
            <div id="log-list"></div>
        </div>

        <div class="inventory-container">
            <div class="filter-bar">
                <button class="filter-btn active" onclick="filtrarEstado('todas', this)">TODAS</button>
                <button class="filter-btn" onclick="filtrarEstado('disponible', this)">LIBRES</button>
                <button class="filter-btn btn-blue" onclick="filtrarEstado('ocupada', this)">OCUPADAS</button>
            </div>
            
            <div class="inventory-tools">
                <div class="search-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" placeholder="Buscar ID..." onkeyup="ejecutarFiltros()">
                </div>
                <button class="btn-export" title="Exportar a Excel (CSV)" onclick="exportarCSV()">
                    <i class="fas fa-file-csv"></i>
                </button>
            </div>

            <div id="grid-placas" class="grid-placas"></div>
        </div>
    </div>

    <div id="modal-resumen">
        <div class="modal-body">
            <h4>Detalles de Placa</h4>
            <div id="resumen-content"></div>
            <button class="btn-close" onclick="document.getElementById('modal-resumen').style.display='none'">Cerrar</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCqROIzmp2guo2XLbdYrSW3ujlUBc7ngOc",
        authDomain: "huellitas-digitales.firebaseapp.com",
        projectId: "huellitas-digitales",
        storageBucket: "huellitas-digitales.firebasestorage.app",
        messagingSenderId: "523935942496",
        appId: "1:523935942496:web:0bb3ad3b28c189345fc005"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const logList = document.getElementById('log-list');
    const countToday = document.getElementById('count-today');

    // VARIABLES GLOBALES PARA FILTROS Y EXPORTACIÓN
    let placasDataGlobal = [];
    let filtroActual = 'todas';

    // 1. MONITOR DE LOGS (ACTIVIDAD RECIENTE)
    const q = query(collection(db, "logs"), orderBy("fecha", "desc"), limit(20));

    onSnapshot(q, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            if (change.type === "added") {
                const data = change.doc.data();
                let hora = '...';
                if (data.fecha) {
                    if (typeof data.fecha.toDate === 'function') hora = data.fecha.toDate().toLocaleTimeString();
                    else if (data.fecha.seconds) hora = new Date(data.fecha.seconds * 1000).toLocaleTimeString();
                }

                let estiloTag = "tag-activation";
                const eventoTexto = data.evento || 'INFO';
                if (eventoTexto.toUpperCase().includes("RESET") || eventoTexto.toUpperCase().includes("ELIMINACIÓN")) {
                    estiloTag = "tag-reset";
                }

                const div = document.createElement('div');
                div.className = `log-entry ${!snapshot.metadata.fromCache ? 'new-entry' : ''}`;
                div.innerHTML = `
                    <span class="placa-id">${data.placaId || '---'}</span>
                    <span>
                        <span class="tag ${estiloTag}">${eventoTexto}</span> 
                        <small style="color:#666; margin-left:10px;">via ${data.origen || 'sys'}</small>
                    </span>
                    <span class="time">${hora}</span>
                `;
                logList.insertBefore(div, logList.firstChild);
            }
        });
        countToday.innerText = snapshot.size;
    });

    // 2. MONITOR DE INVENTARIO (LISTADO DE PLACAS)
    onSnapshot(collection(db, "placas"), (snapshot) => {
        const grid = document.getElementById('grid-placas');
        const countDisp = document.getElementById('total-disp');
        const countOcup = document.getElementById('total-ocup');
        
        let disp = 0;
        let ocup = 0;
        grid.innerHTML = "";
        placasDataGlobal = []; // Limpiamos datos para reconstruir

        snapshot.docs.sort((a, b) => a.id.localeCompare(b.id)).forEach(docSnap => {
            const data = docSnap.data();
            const id = docSnap.id;
            const esActiva = data.activa === true;

            // Guardamos en memoria para exportar después
            placasDataGlobal.push({
                id: id,
                estado: esActiva ? 'OCUPADA' : 'DISPONIBLE',
                mascota: data.mascota || 'N/A',
                email: data.email || 'N/A'
            });

            esActiva ? ocup++ : disp++;

            const div = document.createElement('div');
            div.className = `placa-item ${esActiva ? 'p-ocupada' : 'p-disponible'}`;
            div.innerText = id;
            
            // Atributo para filtrado rápido por CSS/JS
            div.setAttribute('data-status', esActiva ? 'ocupada' : 'disponible');

            // Acción al hacer clic
            div.onclick = () => verResumen(id, data);
            
            grid.appendChild(div);
        });

        countDisp.innerText = disp;
        countOcup.innerText = ocup;
        
        // Re-aplicar filtros si había alguno activo
        ejecutarFiltros();
    });

    // 3. FUNCIÓN PARA VER RESUMEN
    function verResumen(id, data) {
        if (!data.activa) return; // Solo mostrar si está ocupada
        
        const modal = document.getElementById('modal-resumen');
        const content = document.getElementById('resumen-content');
        
        content.innerHTML = `
            <p><b style="color:#aaa">PLACA:</b> ${id}</p>
            <p><b style="color:#aaa">MASCOTA:</b> ${data.mascota || 'Sin nombre'}</p>
            <p><b style="color:#aaa">DUEÑO:</b> ${data.email || 'No registrado'}</p>
            <p><b style="color:#aaa">TELÉFONO:</b> ${data.telefono || 'N/A'}</p>
            <p><b style="color:#aaa">ESTADO:</b> <span class="tag tag-activation">ACTIVA</span></p>
        `;
        
        modal.style.display = 'flex';
    }

    // 4. LÓGICA DE FILTROS Y BUSCADOR
    window.filtrarEstado = (estado, btn) => {
        filtroActual = estado;
        
        // Actualizar visual de botones
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        ejecutarFiltros();
    }

    window.ejecutarFiltros = () => {
        const busqueda = document.getElementById('search-input').value.toUpperCase();
        const items = document.querySelectorAll('.placa-item');
        
        items.forEach(item => {
            const idTexto = item.innerText;
            const statusItem = item.getAttribute('data-status');

            // Condición 1: Coincide con texto
            const matchTexto = idTexto.includes(busqueda);
            
            // Condición 2: Coincide con botón filtro
            const matchEstado = (filtroActual === 'todas') || (statusItem === filtroActual);

            if (matchTexto && matchEstado) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // 5. EXPORTAR A EXCEL (CSV)
    window.exportarCSV = () => {
        if (placasDataGlobal.length === 0) {
            alert("No hay datos para exportar.");
            return;
        }

        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "ID PLACA,ESTADO,NOMBRE MASCOTA,EMAIL DUEÑO\n"; // Cabeceras

        placasDataGlobal.forEach(row => {
            csvContent += `${row.id},${row.estado},${row.mascota},${row.email}\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `Inventario_Huellitas_${new Date().toLocaleDateString()}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Exponer funciones al window para que el HTML las vea
    window.verResumen = verResumen;
</script>
</body>
</html>
