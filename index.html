<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activar Placa | Huellitas Digitales</title>
    <style>
        :root { --primary: #2bb673; --bg: #f4f7f6; --text: #333; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        h2 { text-align: center; color: var(--text); margin-bottom: 20px; }
        .id-badge { background: #e8f5e9; color: var(--primary); padding: 8px; text-align: center; border-radius: 12px; font-weight: bold; margin-bottom: 20px; border: 1px dashed var(--primary); }
        
        /* Previsualizaci√≥n de Foto */
        .photo-upload-container { text-align: center; margin-bottom: 20px; }
        #preview-img { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); display: none; margin: 0 auto 10px; background: #eee; }
        .custom-file-upload { display: inline-block; padding: 10px 20px; cursor: pointer; background: #f0f0f0; border-radius: 10px; font-size: 14px; color: #666; font-weight: bold; border: 1px solid #ddd; }
        
        label { display: block; margin-bottom: 5px; font-size: 13px; color: #666; font-weight: 600; }
        input, textarea { width: 100%; padding: 12px; margin-bottom: 15px; border: 1.5px solid #eee; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        input:focus { border-color: var(--primary); outline: none; }
        
        .pin-hint { font-size: 11px; color: #888; margin-top: -12px; margin-bottom: 15px; display: block; }

        button { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        #status { text-align: center; font-weight: bold; margin-top: 15px; font-size: 14px; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="card">
    <div id="placa-id-display" class="id-badge">ID: Cargando...</div>
    <h2>Activar Mascota</h2>
    
    <div class="photo-upload-container">
        <img id="preview-img" src="#" alt="Vista previa">
        <label for="foto-input" class="custom-file-upload">üì∏ Seleccionar Foto</label>
        <input id="foto-input" type="file" accept="image/*" style="display: none;">
    </div>

    <label>Nombre de la Mascota:</label>
    <input id="mascota" type="text" placeholder="Ej: Max" required>

    <label>PIN de Seguridad (4 d√≠gitos):</label>
    <input id="pin" type="tel" maxlength="4" placeholder="Ej: 1234" pattern="[0-9]*" inputmode="numeric" required>
    <span class="pin-hint">√ösalo para editar el perfil despu√©s.</span>

    <label>Correo Electr√≥nico:</label>
    <input id="correo" type="email" placeholder="ejemplo@correo.com" required>

    <label>Tel√©fono de Contacto:</label>
    <input id="telefono" type="tel" placeholder="WhatsApp o Celular" required>
    
    <label>Notas Importantes:</label>
    <textarea id="mensaje" rows="2" placeholder="Alergias o se√±as (opcional)"></textarea>
    
    <button id="btnActivar">Activar Ahora</button>
    <div id="status"></div>
</div>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCqROIzmp2guo2XLbdYrSW3ujlUBc7ngOc",
        authDomain: "huellitas-digitales.firebaseapp.com",
        projectId: "huellitas-digitales",
        storageBucket: "huellitas-digitales.firebasestorage.app", 
        messagingSenderId: "523935942496",
        appId: "1:523935942496:web:0bb3ad3b28c189345fc005"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    emailjs.init("TWeQlV3AV77UPCLZ6");

    const urlParams = new URLSearchParams(window.location.search);
    const placaId = urlParams.get('id')?.toUpperCase();

    if(placaId) {
        document.getElementById("placa-id-display").innerText = "ID PLACA: " + placaId;
    }

    // L√≥gica de Previsualizaci√≥n de Foto
    document.getElementById("foto-input").onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = document.getElementById("preview-img");
                img.src = event.target.result;
                img.style.display = "block";
            };
            reader.readAsDataURL(file);
        }
    };

    document.getElementById("btnActivar").onclick = async () => {
        const pin = document.getElementById("pin").value;
        const nombre = document.getElementById("mascota").value;
        const statusDiv = document.getElementById("status");
        
        // Validaci√≥n de PIN
        if (pin.length !== 4 || isNaN(pin)) {
            statusDiv.innerHTML = "‚ùå El PIN debe ser de 4 n√∫meros.";
            statusDiv.style.color = "red";
            return;
        }

        if(!placaId || !nombre || !document.getElementById("correo").value) {
            statusDiv.innerHTML = "‚ö†Ô∏è Llena los campos obligatorios.";
            return;
        }

        try {
            statusDiv.innerHTML = '<div class="loader"></div> Validando...';
            const docRef = doc(db, "placas", placaId);
            const docSnap = await getDoc(docRef);

            if (!docSnap.exists() || docSnap.data().activa === true) {
                statusDiv.innerHTML = "‚ö†Ô∏è ID no disponible o ya activado.";
                return;
            }

            // Subida de Foto
            let fotoUrl = "";
            const file = document.getElementById("foto-input").files[0];
            if(file) {
                statusDiv.innerHTML = '<div class="loader"></div> Subiendo foto...';
                const stoRef = sRef(storage, `fotos/${placaId}`);
                await uploadBytes(stoRef, file);
                fotoUrl = await getDownloadURL(stoRef);
            }

            // Guardar en Firestore
            await updateDoc(docRef, {
                mascota: nombre,
                correo: document.getElementById("correo").value,
                telefono: document.getElementById("telefono").value,
                pin: pin,
                mensaje: document.getElementById("mensaje").value,
                foto: fotoUrl,
                activa: true,
                fechaActivacion: serverTimestamp()
            });

            // Enviar Email
            emailjs.send("service_xwx9czt", "template_zgl2oii", {
                to_email: document.getElementById("correo").value,
                nombre_mascota: nombre,
                pin: pin,
                placa_id: placaId
            });

            statusDiv.innerHTML = "‚úÖ ¬°Activada con √©xito!";
            statusDiv.style.color = "green";
            setTimeout(() => window.location.href = `perfil.html?id=${placaId}`, 1500);

        } catch (e) {
            statusDiv.innerHTML = "‚ùå Error: " + e.message;
        }
    };
</script>

</body>
</html>
