<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activar Placa | Huellitas Digitales</title>
    <style>
        :root { --primary: #2bb673; --bg: #f4f7f6; --text: #333; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        h2 { text-align: center; color: var(--text); margin-bottom: 20px; }
        .id-badge { background: #e8f5e9; color: var(--primary); padding: 8px; text-align: center; border-radius: 12px; font-weight: bold; margin-bottom: 20px; border: 1px dashed var(--primary); }
        
        /* Previsualizaci√≥n de Foto */
        .photo-upload-container { text-align: center; margin-bottom: 20px; }
        #preview-img { width: 110px; height: 110px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); display: none; margin: 0 auto 10px; background: #eee; }
        .custom-file-upload { display: inline-block; padding: 10px 20px; cursor: pointer; background: #f0f0f0; border-radius: 10px; font-size: 14px; color: #666; font-weight: bold; border: 1px solid #ddd; }
        
        label { display: block; margin-bottom: 5px; font-size: 13px; color: #666; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 15px; border: 1.5px solid #eee; border-radius: 10px; box-sizing: border-box; font-size: 16px; transition: 0.3s; }
        input:focus, select:focus { border-color: var(--primary); outline: none; background: #f9fffb; }
        
        .pin-hint { font-size: 11px; color: #888; margin-top: -12px; margin-bottom: 15px; display: block; }

        /* Estilos Captcha */
        .captcha-container { background: #f9f9f9; padding: 15px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 15px; text-align: center; }
        #captcha-code { font-family: 'Courier New', Courier, monospace; font-size: 24px; font-weight: bold; letter-spacing: 5px; background: #333; color: #fff; padding: 8px 15px; border-radius: 8px; user-select: none; display: inline-block; margin-bottom: 10px; font-style: italic; text-decoration: line-through; }
        #btn-refresh-captcha { background: none; border: none; color: var(--primary); cursor: pointer; font-size: 12px; text-decoration: underline; margin-bottom: 10px; }

        button#btnActivar { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        #status { text-align: center; font-weight: bold; margin-top: 15px; font-size: 14px; line-height: 1.4; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="card">
    <div id="placa-id-display" class="id-badge">ID: Cargando...</div>
    <h2>Activar Mascota</h2>
    
    <div class="photo-upload-container">
        <img id="preview-img" src="#" alt="Vista previa">
        <label for="foto-input" class="custom-file-upload">üì∏ Foto de la Mascota</label>
        <input id="foto-input" type="file" accept="image/*" style="display: none;">
    </div>

    <label>Nombre de la Mascota:</label>
    <input id="mascota" type="text" placeholder="Ej: Max" required>

    <div style="display: flex; gap: 10px;">
        <div style="width: 50%;">
            <label>PIN (4 d√≠gitos):</label>
            <input id="pin" type="tel" maxlength="4" placeholder="1234" required>
        </div>
        <div style="width: 50%;">
            <label>Confirmar PIN:</label>
            <input id="pin-confirm" type="tel" maxlength="4" placeholder="1234" required>
        </div>
    </div>
    <span class="pin-hint">Indispensable para editar el perfil despu√©s.</span>

    <label>Correo Electr√≥nico:</label>
    <input id="correo" type="email" placeholder="tu@correo.com" required>

    <label>Tel√©fono Celular:</label>
    <div style="display: flex; gap: 8px;">
        <select id="codigo-pais" style="width: 45%; font-size: 14px;">
            <option value="52">üá≤üáΩ +52</option>
            <option value="1">üá∫üá∏ +1</option>
            <option value="34">üá™üá∏ +34</option>
            <option value="57">üá®üá¥ +57</option>
            <option value="54">üá¶üá∑ +54</option>
            <option value="56">üá®üá± +56</option>
            <option value="51">üáµüá™ +51</option>
            <option value="593">üá™üá® +593</option>
            <option value="502">üá¨üáπ +502</option>
            <option value="58">üáªüá™ +58</option>
            <option value="506">üá®üá∑ +506</option>
        </select>
        <input id="telefono" type="tel" placeholder="10 d√≠gitos" style="width: 55%;">
    </div>

    <label>Notas M√©dicas o Mensaje:</label>
    <textarea id="mensaje" rows="2" placeholder="Ej: Al√©rgico al pollo..."></textarea>

    <div class="captcha-container">
        <label>Verificaci√≥n Humana:</label>
        <div id="captcha-code"></div> <br>
        <button id="btn-refresh-captcha" type="button">üîÑ Cambiar c√≥digo</button>
        <input id="captcha-input" type="text" placeholder="Escribe el c√≥digo" style="text-align:center; text-transform:uppercase;">
    </div>
    
    <button id="btnActivar">Activar Ahora</button>
    <div id="status"></div>
</div>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCqROIzmp2guo2XLbdYrSW3ujlUBc7ngOc",
        authDomain: "huellitas-digitales.firebaseapp.com",
        projectId: "huellitas-digitales",
        storageBucket: "huellitas-digitales.firebasestorage.app", 
        messagingSenderId: "523935942496",
        appId: "1:523935942496:web:0bb3ad3b28c189345fc005"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    emailjs.init("TWeQlV3AV77UPCLZ6");

    let currentCaptcha = "";

    function generateCaptcha() {
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        let result = "";
        for (let i = 0; i < 6; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
        currentCaptcha = result;
        document.getElementById("captcha-code").innerText = result;
    }

    generateCaptcha();
    document.getElementById("btn-refresh-captcha").onclick = generateCaptcha;

    const urlParams = new URLSearchParams(window.location.search);
    const placaId = urlParams.get('id')?.toUpperCase();
    if(placaId) document.getElementById("placa-id-display").innerText = "ID PLACA: " + placaId;

    // Vista previa de imagen
    document.getElementById("foto-input").onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = document.getElementById("preview-img");
                img.src = ev.target.result;
                img.style.display = "block";
            }
            reader.readAsDataURL(file);
        }
    };

    document.getElementById("btnActivar").onclick = async () => {
        const statusDiv = document.getElementById("status");
        const pin = document.getElementById("pin").value;
        const pinConfirm = document.getElementById("pin-confirm").value;
        const captchaInput = document.getElementById("captcha-input").value.toUpperCase();
        const codigoPais = document.getElementById("codigo-pais").value;
        const numLocal = document.getElementById("telefono").value.replace(/\D/g,'');

        // Validaciones
        if (pin.length !== 4 || pin !== pinConfirm) {
            statusDiv.innerHTML = "‚ùå Los PIN no coinciden o no son de 4 d√≠gitos.";
            statusDiv.style.color = "red";
            return;
        }
        if (captchaInput !== currentCaptcha) {
            statusDiv.innerHTML = "‚ùå C√≥digo de verificaci√≥n incorrecto.";
            statusDiv.style.color = "red";
            generateCaptcha();
            return;
        }
        if (numLocal.length < 8) {
            statusDiv.innerHTML = "‚ùå Tel√©fono incompleto.";
            statusDiv.style.color = "red";
            return;
        }

        try {
            statusDiv.innerHTML = '<div class="loader"></div> Verificando ID...';
            statusDiv.style.color = "#333";
            
            const docRef = doc(db, "placas", placaId);
            const docSnap = await getDoc(docRef);

            if (!docSnap.exists() || docSnap.data().activa === true) {
                statusDiv.innerHTML = "‚ö†Ô∏è Esta placa no es v√°lida o ya fue activada.";
                statusDiv.style.color = "orange";
                return;
            }

            statusDiv.innerHTML = '<div class="loader"></div> Guardando informaci√≥n...';
            
            let fotoUrl = "";
            const file = document.getElementById("foto-input").files[0];
            if(file) {
                const sRef = ref(storage, `fotos/${placaId}`);
                await uploadBytes(sRef, file);
                fotoUrl = await getDownloadURL(sRef);
            }

            const telefonoFinal = codigoPais + numLocal;

            await updateDoc(docRef, {
                mascota: document.getElementById("mascota").value,
                correo: document.getElementById("correo").value,
                telefono: telefonoFinal,
                pin: pin,
                mensaje: document.getElementById("mensaje").value,
                foto: fotoUrl,
                activa: true,
                fechaActivacion: serverTimestamp()
            });

            // EmailJS
            emailjs.send("service_xwx9czt", "template_zgl2oii", {
                to_email: document.getElementById("correo").value,
                nombre_mascota: document.getElementById("mascota").value,
                pin: pin,
                placa_id: placaId
            });

            statusDiv.innerHTML = "‚úÖ ¬°Activaci√≥n exitosa! Redirigiendo...";
            statusDiv.style.color = "green";
            setTimeout(() => window.location.href = `perfil.html?id=${placaId}`, 1500);

        } catch (e) {
            statusDiv.innerHTML = "‚ùå Error: " + e.message;
            statusDiv.style.color = "red";
        }
    };
</script>

</body>
</html>
