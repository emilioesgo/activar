<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carnet Digital | Huellitas</title>
    <style>
        :root { --primary: #2bb673; --accent: #4a90e2; --bg: #f0f4f8; --danger: #ff4757; --history: #6c757d; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; padding-top: 70px; }
        
        .navbar { position: fixed; top: 0; left: 0; right: 0; background: white; padding: 15px; display: flex; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .btn-back { background: #eee; border: none; padding: 8px 12px; border-radius: 10px; cursor: pointer; text-decoration: none; color: #333; font-weight: bold; margin-right: 15px; }

        .carnet-container { max-width: 500px; margin: 0 auto; }
        
        .pet-header { 
            background: white; border-radius: 25px 25px 0 0; padding: 20px; 
            display: flex; align-items: center; gap: 15px; border-bottom: 2px dashed #eee;
        }
        .pet-photo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); }
        .pet-info h2 { margin: 0; color: #333; font-size: 22px; }
        
        .vaccine-list { background: white; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .section-label { font-size: 11px; font-weight: bold; color: #aaa; text-transform: uppercase; margin-bottom: 10px; display: block; }

        .vaccine-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f9f9f9; }
        .v-info { display: flex; flex-direction: column; }
        .v-name { font-weight: bold; font-size: 14px; color: #444; }
        .v-date { font-size: 12px; color: #888; }
        
        .v-counter { background: #e8f5e9; color: var(--primary); padding: 4px 10px; border-radius: 10px; font-size: 10px; font-weight: 800; }
        .v-urgent { background: #ffebee; color: var(--danger); }
        .v-applied { background: #f0f0f0; color: var(--history); }

        .add-form { background: #fff; padding: 20px; border-radius: 0 0 25px 25px; margin-bottom: 30px; border: 1px solid #eee; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 12px; box-sizing: border-box; font-size: 14px; }
        .btn-add { background: var(--primary); color: white; border: none; width: 100%; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <nav class="navbar">
        <a href="hub.html" class="btn-back">â¬… Volver</a>
        <h1 style="font-size: 18px; margin: 0;">ðŸ“‹ Carnet y Agenda Canina</h1>
    </nav>

    <div class="carnet-container" id="main-container"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, addDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCqROIzmp2guo2XLbdYrSW3ujlUBc7ngOc",
        authDomain: "huellitas-digitales.firebaseapp.com",
        projectId: "huellitas-digitales",
        storageBucket: "huellitas-digitales.firebasestorage.app",
        messagingSenderId: "523935942496",
        appId: "1:523935942496:web:0bb3ad3b28c189345fc005"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const email = localStorage.getItem("userEmail");

    async function cargarCarnets() {
        const container = document.getElementById("main-container");
        const qMascotas = query(collection(db, "placas"), where("email", "==", email));
        const snapMascotas = await getDocs(qMascotas);
        
        container.innerHTML = "";

        for (const petDoc of snapMascotas.docs) {
            const pet = petDoc.data();
            const petId = petDoc.id;

            container.innerHTML += `
                <div id="carnet-${petId}">
                    <div class="pet-header">
                        <img src="${pet.foto || 'assets/img/logo.png'}" class="pet-photo">
                        <div class="pet-info">
                            <h2>${pet.mascota}</h2>
                        </div>
                    </div>
                    
                    <div class="vaccine-list">
                        <span class="section-label">ðŸ“… Agenda (PrÃ³ximas Citas)</span>
                        <div id="agenda-${petId}"></div>
                        
                        <span class="section-label" style="margin-top:20px;">âœ… Historial (Ya puestas)</span>
                        <div id="historial-${petId}"></div>
                    </div>
                    
                    <div class="add-form">
                        <p style="margin:0 0 10px 0; font-size:13px; font-weight:bold;">Registrar nueva entrada</p>
                        <select id="tipo-${petId}">
                            <option value="agenda">PrÃ³xima Cita / Vacuna</option>
                            <option value="historial">Vacuna ya Aplicada</option>
                        </select>
                        <input type="text" id="name-${petId}" placeholder="Â¿QuÃ© vacuna o tratamiento?">
                        <input type="date" id="date-${petId}">
                        <button class="btn-add" onclick="window.guardarEntrada('${petId}', '${pet.mascota}')">Guardar en Carnet</button>
                    </div>
                </div>`;
            
            await cargarRegistrosMascota(petId);
        }
    }

    async function cargarRegistrosMascota(petId) {
        const agendaDiv = document.getElementById(`agenda-${petId}`);
        const historialDiv = document.getElementById(`historial-${petId}`);
        
        const qVax = query(collection(db, "recordatorios"), where("petId", "==", petId));
        const snapVax = await getDocs(qVax);
        
        agendaDiv.innerHTML = historialDiv.innerHTML = "";
        
        snapVax.forEach(vDoc => {
            const v = vDoc.data();
            const hoy = new Date();
            const fechaVax = new Date(v.fecha);
            const diffDays = Math.ceil((fechaVax - hoy) / (1000 * 60 * 60 * 24));
            
            let badge = "";
            if (v.tipo === "historial") {
                badge = `<span class="v-counter v-applied">Aplicada</span>`;
            } else {
                badge = diffDays < 0 ? `<span class="v-counter v-urgent">Vencida</span>` : `<span class="v-counter">Faltan ${diffDays} dÃ­as</span>`;
            }

            const itemHtml = `
                <div class="vaccine-item">
                    <div class="v-info">
                        <span class="v-name">${v.tipo === 'agenda' ? 'ðŸ•’' : 'ðŸ’‰'} ${v.vacuna}</span>
                        <span class="v-date">${v.fecha}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        ${badge}
                        <button onclick="window.borrarRegistro('${vDoc.id}', '${petId}')" style="background:none; border:none; color:#ccc; cursor:pointer;">âœ•</button>
                    </div>
                </div>`;

            if (v.tipo === "historial") historialDiv.innerHTML += itemHtml;
            else agendaDiv.innerHTML += itemHtml;
        });
    }

    window.guardarEntrada = async (petId, petName) => {
        const tipo = document.getElementById(`tipo-${petId}`).value;
        const nombre = document.getElementById(`name-${petId}`).value;
        const fecha = document.getElementById(`date-${petId}`).value;

        if(!nombre || !fecha) return alert("Completa los datos");

        await addDoc(collection(db, "recordatorios"), {
            petId, petName, userEmail: email, vacuna: nombre, fecha, tipo
        });
        
        document.getElementById(`name-${petId}`).value = "";
        cargarRegistrosMascota(petId);
    };

    window.borrarRegistro = async (id, petId) => {
        if(confirm("Â¿Eliminar este dato del carnet?")) {
            await deleteDoc(doc(db, "recordatorios", id));
            cargarRegistrosMascota(petId);
        }
    };

    cargarCarnets();
</script>
</body>
</html>
