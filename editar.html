<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Editar Perfil | Huellitas Digitales</title>
    <style>
        :root { --primary: #2bb673; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        .hidden { display: none; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        #mensaje-status { text-align: center; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2 id="titulo">üîí Acceso al Perfil</h2>
    
    <div id="seccion-login">
        <p>Ingresa tu PIN para editar los datos de tu mascota.</p>
        <input id="login-pin" type="password" placeholder="Ingresa tu PIN">
        <button id="btn-verificar">Verificar PIN</button>
    </div>

    <div id="seccion-editor" class="hidden">
        <label>Tel√©fono de contacto:</label>
        <input id="edit-tel" type="tel">
        
        <label>Informaci√≥n/Mensaje:</label>
        <textarea id="edit-msj" rows="4"></textarea>
        
        <button id="btn-guardar">Guardar Cambios</button>
    </div>

    <div id="mensaje-status"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCqROIzmp2guo2XLbdYrSW3ujlUBc7ngOc",
        authDomain: "huellitas-digitales.firebaseapp.com",
        projectId: "huellitas-digitales",
        storageBucket: "huellitas-digitales.firebasestorage.app",
        messagingSenderId: "523935942496",
        appId: "1:523935942496:web:0bb3ad3b28c189345fc005"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const urlParams = new URLSearchParams(window.location.search);
    const placaId = urlParams.get('id')?.toUpperCase();
    const status = document.getElementById("mensaje-status");

    // 1. VERIFICAR PIN
    document.getElementById("btn-verificar").onclick = async () => {
        const pinIngresado = document.getElementById("login-pin").value;
        const docRef = doc(db, "placas", placaId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists() && docSnap.data().pin === pinIngresado) {
            status.innerText = "‚úÖ PIN Correcto";
            status.style.color = "green";
            document.getElementById("seccion-login").classList.add("hidden");
            document.getElementById("seccion-editor").classList.remove("hidden");
            
            // Cargar datos actuales
            document.getElementById("edit-tel").value = docSnap.data().telefono;
            document.getElementById("edit-msj").value = docSnap.data().mensaje;
        } else {
            status.innerText = "‚ùå PIN incorrecto o placa no activa";
            status.style.color = "red";
        }
    };

    // 2. GUARDAR CAMBIOS
    document.getElementById("btn-guardar").onclick = async () => {
        const docRef = doc(db, "placas", placaId);
        try {
            await updateDoc(docRef, {
                telefono: document.getElementById("edit-tel").value,
                mensaje: document.getElementById("edit-msj").value
            });
            status.innerText = "‚ú® ¬°Datos actualizados con √©xito!";
            status.style.color = "green";
        } catch (e) {
            status.innerText = "‚ùå Error al guardar";
        }
    };
</script>
</body>
</html>
