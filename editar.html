<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control | Huellitas Digitales</title>
    <style>
        :root { --primary: #2bb673; --bg: #f4f7f6; --text: #333; --error: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 0; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 100%; max-width: 450px; overflow: hidden; }
        
        .header { background: var(--primary); color: white; padding: 25px; text-align: center; }
        .header h2 { margin: 0; font-size: 20px; }
        .id-badge { display: inline-block; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 12px; margin-top: 8px; }

        .content { padding: 25px; }
        .hidden { display: none; }

        /* Estilo de Previsualizaci√≥n de Foto */
        .photo-edit-section { text-align: center; margin-bottom: 20px; }
        .current-photo-preview { width: 120px; height: 120px; border-radius: 60px; object-fit: cover; border: 3px solid var(--primary); margin-bottom: 10px; background: #eee; }
        
        label { display: block; margin-bottom: 6px; font-size: 13px; color: #666; font-weight: 600; }
        input, textarea { width: 100%; padding: 12px; margin-bottom: 18px; border: 1.5px solid #eee; border-radius: 12px; box-sizing: border-box; font-size: 15px; transition: 0.3s; }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; background: #f9fffb; }
        
        button { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { filter: brightness(0.9); transform: translateY(-1px); }
        button:disabled { background: #ccc; }

        .btn-secondary { background: #f0f0f0; color: #666; margin-top: 10px; }

        #status { text-align: center; margin-top: 15px; font-size: 14px; font-weight: 500; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="card">
    <div class="header">
        <h2 id="main-title">üîí Acceso Propietario</h2>
        <div id="placa-id-display" class="id-badge">ID: Cargando...</div>
    </div>

    <div class="content">
        <div id="seccion-login">
            <label>PIN de Seguridad:</label>
            <input id="login-pin" type="password" placeholder="Ingresa tu PIN">
            <button id="btn-verificar">Acceder al Editor</button>
            <p style="font-size: 12px; color: #999; text-align: center;">Este PIN fue creado al activar la placa por primera vez.</p>
        </div>

        <div id="seccion-editor" class="hidden">
            <div class="photo-edit-section">
                <img id="current-photo" class="current-photo-preview" src="" alt="Foto Mascota">
                <label for="new-photo" style="color: var(--primary); cursor: pointer;">Cambiar Foto de Perfil</label>
                <input id="new-photo" type="file" accept="image/*" style="display: none;">
            </div>

            <label>Nombre de la Mascota:</label>
            <input id="edit-nombre" type="text" placeholder="Nombre">

            <label>Tel√©fono de Contacto:</label>
            <input id="edit-tel" type="tel" placeholder="N√∫mero con clave lada">

            <label>Informaci√≥n M√©dica o Notas:</label>
            <textarea id="edit-msj" rows="4" placeholder="Alergias, medicamentos, se√±as particulares..."></textarea>

            <button id="btn-guardar">Guardar Cambios</button>
            <button onclick="window.location.reload()" class="btn-secondary">Cancelar</button>
        </div>

        <div id="status"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCqROIzmp2guo2XLbdYrSW3ujlUBc7ngOc",
        authDomain: "huellitas-digitales.firebaseapp.com",
        projectId: "huellitas-digitales",
        storageBucket: "huellitas-digitales.firebasestorage.app",
        messagingSenderId: "523935942496",
        appId: "1:523935942496:web:0bb3ad3b28c189345fc005"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const urlParams = new URLSearchParams(window.location.search);
    const placaId = urlParams.get('id')?.toUpperCase();
    const status = document.getElementById("status");

    if(placaId) document.getElementById("placa-id-display").innerText = "ID: " + placaId;

    // --- PASO 1: VALIDAR PIN ---
    document.getElementById("btn-verificar").onclick = async () => {
        const pin = document.getElementById("login-pin").value;
        status.innerHTML = '<div class="loader"></div> Verificando...';

        try {
            const docRef = doc(db, "placas", placaId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists() && docSnap.data().pin === pin) {
                const d = docSnap.data();
                status.innerText = "";
                document.getElementById("seccion-login").classList.add("hidden");
                document.getElementById("seccion-editor").classList.remove("hidden");
                document.getElementById("main-title").innerText = "üìù Editar Mascota";

                // Pre-cargar datos
                document.getElementById("edit-nombre").value = d.mascota || "";
                document.getElementById("edit-tel").value = d.telefono || "";
                document.getElementById("edit-msj").value = d.mensaje || "";
                document.getElementById("current-photo").src = d.foto || "https://via.placeholder.com/150";
            } else {
                status.innerText = "‚ùå PIN incorrecto.";
                status.style.color = "var(--error)";
            }
        } catch (e) { status.innerText = "Error: " + e.message; }
    };

    // Previsualizar nueva foto antes de subir
    document.getElementById("new-photo").onchange = (e) => {
        const reader = new FileReader();
        reader.onload = () => document.getElementById("current-photo").src = reader.result;
        reader.readAsDataURL(e.target.files[0]);
    };

    // --- PASO 2: GUARDAR CAMBIOS ---
    document.getElementById("btn-guardar").onclick = async () => {
        const btn = document.getElementById("btn-guardar");
        const file = document.getElementById("new-photo").files[0];
        btn.disabled = true;
        status.innerHTML = '<div class="loader"></div> Actualizando perfil...';

        try {
            let fotoUrl = document.getElementById("current-photo").src;

            // Si hay una foto nueva, subirla
            if(file) {
                const sRef = ref(storage, `fotos/${placaId}`);
                await uploadBytes(sRef, file);
                fotoUrl = await getDownloadURL(sRef);
            }

            const docRef = doc(db, "placas", placaId);
            await updateDoc(docRef, {
                mascota: document.getElementById("edit-nombre").value,
                telefono: document.getElementById("edit-tel").value,
                mensaje: document.getElementById("edit-msj").value,
                foto: fotoUrl
            });

            status.innerHTML = "‚ú® ¬°Cambios guardados con √©xito!";
            status.style.color = "var(--primary)";
            setTimeout(() => window.location.href = `perfil.html?id=${placaId}`, 1500);

        } catch (e) {
            status.innerText = "‚ùå Error al guardar.";
            btn.disabled = false;
        }
    };
</script>
</body>
</html>
