<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoreo de Peso | Huellitas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2bb673; --bg: #f8fafb; --text: #333; --accent: #2196f3; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; padding-top: 70px; color: var(--text); }
        .navbar { position: fixed; top: 0; left: 0; right: 0; background: white; padding: 15px; display: flex; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .btn-back { background: #eee; border: none; padding: 8px 12px; border-radius: 10px; cursor: pointer; text-decoration: none; color: #333; font-weight: bold; }
        .container { max-width: 500px; margin: 0 auto; }
        .card { background: white; border-radius: 25px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { font-size: 18px; margin: 0 0 15px 0; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        label { display: block; font-size: 11px; font-weight: 800; color: #aaa; text-transform: uppercase; margin-bottom: 5px; margin-top: 15px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 12px; box-sizing: border-box; font-size: 15px; background: #fafafa; }
        
        .bcs-container { display: flex; overflow-x: auto; gap: 10px; padding: 5px 0 15px; scrollbar-width: none; }
        .bcs-item { min-width: 110px; padding: 12px; border: 2px solid #f0f0f0; border-radius: 18px; text-align: center; cursor: pointer; transition: 0.2s; background: white; }
        .bcs-item.active { border-color: var(--primary); background: #e8f5e9; transform: scale(1.05); }
        
        .info-box { background: #e3f2fd; border-radius: 18px; padding: 18px; font-size: 13px; line-height: 1.5; color: #1565c0; border-left: 5px solid var(--accent); }
        .footer-science { margin-top: 30px; padding: 20px; text-align: center; border-top: 1px solid #eee; }
        .footer-science p { font-size: 10px; color: #999; line-height: 1.6; }
    </style>
</head>
<body>

    <nav class="navbar">
        <a href="hub.html" class="btn-back">‚¨Ö Volver</a>
        <h1 style="font-size: 17px; margin-left: 15px;">‚öñÔ∏è Monitoreo de Peso</h1>
    </nav>

    <div class="container">
        <div class="card">
            <h2>üìà Historial de Peso</h2>
            <canvas id="weightChart" height="200"></canvas>
        </div>

        <div class="card">
            <h2>üìù Nuevo Registro</h2>
            
            <label>Seleccionar Mascota</label>
            <select id="select-mascota">
                <option value="">Cargando mascotas...</option>
            </select>

            <label>Peso Actual (KG)</label>
            <input type="number" id="input-peso" step="0.1" placeholder="Ej: 12.5">

            <label>Estado Reproductivo / Actividad</label>
            <select id="select-factor">
                <option value="1.6">Adulto Castrado (Mantenimiento)</option>
                <option value="1.8">Adulto Entero (Mantenimiento)</option>
                <option value="1.2">Poco Activo / Propenso a Obesidad</option>
                <option value="1.0">P√©rdida de Peso (Dieta)</option>
                <option value="3.0">Cachorro (Crecimiento)</option>
            </select>
            
            <label>Condici√≥n Corporal (Escala WSAVA)</label>
            <div class="bcs-container" id="bcs-selector">
                <div class="bcs-item" onclick="selectBCS(2, this)">‚öñÔ∏è<br><span style="font-size:10px;">2: Delgado</span></div>
                <div class="bcs-item active" onclick="selectBCS(5, this)">‚úÖ<br><span style="font-size:10px;">5: Ideal</span></div>
                <div class="bcs-item" onclick="selectBCS(8, this)">üî¥<br><span style="font-size:10px;">8: Obesidad</span></div>
            </div>

            <button style="background:var(--primary); color:white; border:none; width:100%; padding:16px; border-radius:15px; font-weight:bold; cursor:pointer;" id="btn-registrar">Actualizar Expediente</button>
        </div>

        <div class="card">
            <h2>üçé Plan Nutricional Sugerido</h2>
            <div id="nutricion-info">
                <p style="color:#aaa; font-size: 13px;">Registra el peso para ver los requerimientos seg√∫n la WSAVA.</p>
            </div>
        </div>

        <div class="footer-science">
            <p>
                <b>FUENTES CIENT√çFICAS:</b><br>
                C√°lculos de Requerimiento Energ√©tico en Reposo (RER) basados en la f√≥rmula alom√©trica est√°ndar de la <b>WSAVA</b> (World Small Animal Veterinary Association). Evaluaci√≥n de Condici√≥n Corporal seg√∫n la escala de 9 puntos validada por la <b>AAHA</b> (American Animal Hospital Association).
                <br><br>
                <i>* Esta herramienta es para monitoreo dom√©stico y no sustituye la evaluaci√≥n cl√≠nica de un m√©dico veterinario.</i>
            </p>
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTR9XXCcOdUumx-a_w9TPCppJmpkUsphiG1Ug&s" height="20" style="opacity: 0.5; margin-top: 10px;">
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCqROIzmp2guo2XLbdYrSW3ujlUBc7ngOc",
        authDomain: "huellitas-digitales.firebaseapp.com",
        projectId: "huellitas-digitales",
        storageBucket: "huellitas-digitales.firebasestorage.app",
        messagingSenderId: "523935942496",
        appId: "1:523935942496:web:0bb3ad3b28c189345fc005"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const email = localStorage.getItem("userEmail");
    let myChart = null;
    let bcsSeleccionado = 5;

    window.selectBCS = (v, e) => {
        document.querySelectorAll('.bcs-item').forEach(i => i.classList.remove('active'));
        e.classList.add('active'); bcsSeleccionado = v;
    };

    async function cargarSelector() {
        const q = query(collection(db, "placas"), where("email", "==", email));
        const snap = await getDocs(q);
        const sel = document.getElementById("select-mascota");
        sel.innerHTML = "";
        snap.forEach(doc => {
            sel.innerHTML += `<option value="${doc.id}">${doc.data().mascota}</option>`;
        });
        if(sel.value) cargarHistorial(sel.value);
    }

    async function cargarHistorial(petId) {
        const q = query(collection(db, "historial_peso"), where("petId", "==", petId), orderBy("timestamp", "asc"));
        const snap = await getDocs(q);
        const pesos = []; const fechas = []; let ultimo = null;
        snap.forEach(doc => {
            pesos.push(doc.data().peso);
            fechas.push(doc.data().fecha);
            ultimo = doc.data();
        });

        if(myChart) myChart.destroy();
        if(pesos.length > 0) {
            renderChart(fechas, pesos);
            calcularNutricion(ultimo.peso, ultimo.factor);
        }
    }

    function renderChart(labels, data) {
        myChart = new Chart(document.getElementById('weightChart'), {
            type: 'line',
            data: { labels, datasets: [{ label: 'Kg', data, borderColor: '#2bb673', fill: true, backgroundColor: 'rgba(43,182,115,0.1)', tension: 0.4 }] }
        });
    }

    function calcularNutricion(p, f) {
        const rer = Math.round(70 * Math.pow(p, 0.75));
        const total = Math.round(rer * f);
        document.getElementById('nutricion-info').innerHTML = `
            <div class="info-box">
                <b>Gasto en Reposo (RER):</b> ${rer} kcal/d√≠a<br>
                <b>Objetivo Diario: ${total} kcal/d√≠a</b><br>
                <small>Basado en gu√≠as nutricionales de la WSAVA.</small>
            </div>`;
    }

    document.getElementById('btn-registrar').onclick = async () => {
        const p = document.getElementById('input-peso').value;
        const petId = document.getElementById('select-mascota').value;
        const factor = document.getElementById('select-factor').value;
        if(!p || !petId) return alert("Completa los datos");
        await addDoc(collection(db, "historial_peso"), {
            userEmail: email, petId, peso: parseFloat(p), factor: parseFloat(factor),
            bcs: bcsSeleccionado, timestamp: Date.now(),
            fecha: new Date().toLocaleDateString('es-ES', {day:'2-digit', month:'short'})
        });
        location.reload();
    };

    document.getElementById('select-mascota').onchange = (e) => cargarHistorial(e.target.value);
    cargarSelector();
</script>
</body>
</html>
