<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Flyer | Huellitas</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { --danger: #e74c3c; --text: #2c3e50; --share: #3498db; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }

        .flyer-canvas {
            width: 320px;
            background: white;
            border: 12px solid var(--danger);
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            position: relative; /* Necesario para posicionar el logo */
        }

        .header-lost {
            background: var(--danger); color: white;
            padding: 10px; font-size: 28px; font-weight: 900;
            text-transform: uppercase; margin: -20px -20px 20px -20px;
        }

        #logo-huellitas {
            position: absolute;
            top: 15px; /* Ajusta la posición vertical según tu preferencia */
            right: 15px; /* Ajusta la posición horizontal según tu preferencia */
            width: 80px; /* Tamaño del logo */
            height: auto;
            z-index: 10;
        }
        #logo-huellitas img {
            width: 100%;
            height: auto;
        }

        #pet-img { width: 100%; height: 250px; object-fit: cover; border-radius: 10px; }
        
        .pet-name { font-size: 32px; color: var(--danger); margin: 15px 0 5px; font-weight: 800; }
        
        .pet-features { 
            background: #fff5f5; border: 1px solid #ffcccc; 
            padding: 10px; border-radius: 10px; margin-bottom: 15px;
            font-size: 13px; color: #c0392b; font-weight: 700;
        }

        .pet-info { font-size: 14px; color: var(--text); margin-bottom: 20px; font-weight: bold; }

        .qr-section {
            background: #f9f9f9; padding: 10px; border-radius: 15px;
            display: flex; flex-direction: column; align-items: center; border: 2px dashed #ccc;
        }

        .footer-contact { font-size: 22px; font-weight: 800; color: var(--danger); margin-top: 15px; }

        /* Botones */
        .controls { 
            margin-top: 25px; display: grid; 
            grid-template-columns: 1fr 1fr; gap: 10px; width: 320px; 
        }
        .btn {
            padding: 12px; border: none; border-radius: 15px; 
            font-weight: bold; cursor: pointer; display: flex; 
            align-items: center; justify-content: center; gap: 8px; font-size: 13px;
        }
        .btn-download { background: var(--text); color: white; }
        .btn-share { background: var(--share); color: white; }
        .btn-print { background: #95a5a6; color: white; grid-column: span 2; }
        
        .btn-back { margin-bottom: 15px; color: #7f8c8d; text-decoration: none; font-size: 14px; }

        .hidden { display: none; }
        @media print { .controls, .btn-back { display: none; } }
    </style>
</head>
<body>

    <a href="hub.html" class="btn-back"><i class="fas fa-chevron-left"></i> Volver al Hub</a>

    <div class="flyer-canvas" id="flyer-area">
        <div class="header-lost">¡SE BUSCA!</div>
        
        <div id="logo-huellitas">
            <img src="assets/img/logo.png" alt="Huellitas Digitales Logo">
        </div>

        <img id="pet-img" src="assets/img/logo.png" crossorigin="anonymous">
        
        <div class="pet-name" id="pet-name">Cargando...</div>
        
        <div id="features-box" class="pet-features hidden">
            <i class="fas fa-search"></i> Señas: <span id="pet-features-txt"></span>
        </div>

        <div class="pet-info">Ayúdame a volver a casa. Si me ves, toma una foto o escanea el código.</div>
        
        <div class="qr-section">
            <div id="qrcode"></div>
            <div style="font-size: 10px; font-weight: bold; margin-top: 5px;">ESCANEA PARA AYUDAR</div>
        </div>
        
        <div class="footer-contact" id="pet-phone">Cargando...</div>
    </div>

    <div class="controls">
        <button class="btn btn-download" id="download-btn"><i class="fas fa-download"></i> Bajar JPG</button>
        <button class="btn btn-share" id="share-btn"><i class="fas fa-share-alt"></i> Compartir</button>
        <button class="btn btn-print" onclick="window.print()"><i class="fas fa-print"></i> Imprimir Hoja</button>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCqROIzmp2guo2XLbdYrSW3ujlUBc7ngOc",
        authDomain: "huellitas-digitales.firebaseapp.com",
        projectId: "huellitas-digitales",
        storageBucket: "huellitas-digitales.firebasestorage.app",
        messagingSenderId: "523935942496",
        appId: "1:523935942496:web:0bb3ad3b28c189345fc005"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function init() {
        const id = new URLSearchParams(window.location.search).get('id');
        if (!id) return;

        const docSnap = await getDoc(doc(db, "placas", id.toUpperCase()));
        if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById('pet-name').innerText = data.mascota;
            document.getElementById('pet-phone').innerText = `Cel: ${data.telefono}`;
            
            // Lógica de Señas Particulares
            if (data.senas && data.senas.trim() !== "") {
                document.getElementById('pet-features-txt').innerText = data.senas;
                document.getElementById('features-box').classList.remove('hidden');
            }

            if(data.foto) document.getElementById('pet-img').src = data.foto;

            new QRCode(document.getElementById("qrcode"), {
                text: `https://emilioesgo.github.io/activar/perfil.html?id=${id.toUpperCase()}`,
                width: 100, height: 100
            });
        }
    }

    // DESCARGAR JPG
    document.getElementById('download-btn').onclick = async () => {
        const area = document.querySelector("#flyer-area");
        const canvas = await html2canvas(area, { 
            useCORS: true,
            scale: 2 // Doble calidad
        });
        const link = document.createElement('a');
        link.download = `Busqueda-${document.getElementById('pet-name').innerText}.jpg`;
        link.href = canvas.toDataURL("image/jpeg", 0.9);
        link.click();
    };

    // COMPARTIR NATIVO
    document.getElementById('share-btn').onclick = async () => {
        const area = document.querySelector("#flyer-area");
        const canvas = await html2canvas(area, { useCORS: true, scale: 2 });
        canvas.toBlob(async (blob) => {
            const file = new File([blob], 'ayuda_mascota.jpg', { type: 'image/jpeg' });
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: '¡URGENTE: Mascota Perdida!',
                        text: `Ayúdanos a encontrar a ${document.getElementById('pet-name').innerText}. Comparte este flyer.`
                    });
                } catch (err) { console.log("Compartir cancelado"); }
            } else {
                alert("Descarga el flyer y compártelo manualmente por WhatsApp.");
            }
        });
    };

    init();
</script>
</body>
</html>
