<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de Mascota | Huellitas Digitales</title>
    <link rel="icon" type="image/png" href="assets/img/favicon.png">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root { --primary: #2bb673; --whatsapp: #25D366; --bg: #f0f2f5; --text: #2c3e50; --medical: #e6fffa; --medical-border: #b2f5ea; --danger: #e53e3e; --info: #3498db; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; color: var(--text); }
        
        .profile-card { background: white; width: 100%; max-width: 450px; min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        .is-lost { border: 5px solid var(--danger); }
        .lost-banner { display: none; background: var(--danger); color: white; text-align: center; padding: 10px; font-weight: bold; position: sticky; top: 0; z-index: 100; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .photo-container { width: 100%; height: 350px; background: #fff; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #pet-photo { width: 100%; height: 100%; object-fit: cover; }
        .img-logo-fallback { width: 60% !important; height: auto !important; object-fit: contain !important; opacity: 0.8; }
        
        .status-badge { position: absolute; bottom: 20px; left: 20px; background: var(--primary); color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 10; }

        .info-content { padding: 30px; border-radius: 30px 30px 0 0; background: white; margin-top: -30px; position: relative; z-index: 20; }
        h1 { margin: 0; font-size: 32px; }
        .breed { color: #888; font-size: 16px; margin-bottom: 20px; display: block; }

        .emergency-box { background: #fff5f5; border: 1px dashed #feb2b2; padding: 15px; border-radius: 15px; margin-bottom: 15px; }
        .medical-box { background: var(--medical); border: 1px solid var(--medical-border); padding: 15px; border-radius: 15px; margin-bottom: 25px; }

        .actions { display: grid; gap: 12px; }
        .btn { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 16px; border-radius: 15px; text-decoration: none; color: white; font-weight: bold; font-size: 16px; transition: 0.3s; border: none; cursor: pointer; }
        .btn-call { background: var(--primary); }
        .btn-wa { background: var(--whatsapp); }
        .btn-report { background: var(--info); margin-top: 5px; border: 2px solid white; box-shadow: 0 4px 10px rgba(52,152,219,0.3); }

        footer { text-align: center; padding: 40px 20px; font-size: 12px; color: #aaa; background: #fafafa; border-top: 1px solid #eee; }
        .btn-owner { display: inline-block; background: #2c3e50; color: white; padding: 10px 20px; border-radius: 10px; text-decoration: none; font-weight: bold; margin-top: 15px; font-size: 14px; border: none; cursor: pointer; }

        .hidden { display: none !important; }
        .loading { text-align: center; padding: 100px 20px; }
    </style>
</head>
<body>

<div id="loading-view" class="loading">
    <img src="assets/img/logo.png" width="80" style="margin-bottom: 20px; opacity: 0.5;">
    <p>Buscando informaci√≥n...</p>
</div>

<div id="not-sold-view" class="profile-card" style="display: none;">
    <div class="status-container" style="text-align: center; padding: 60px 30px;">
        <img src="assets/img/logo.png" width="100">
        <h2>Placa no disponible</h2>
    </div>
</div>

<div id="not-active-view" class="profile-card" style="display: none;">
    <div class="status-container" style="text-align: center; padding: 60px 30px;">
        <img src="assets/img/logo.png" width="100" style="margin-bottom: 30px;">
        <h2 style="color: var(--text); margin-bottom: 10px;">¬°Placa Detectada!</h2>
        <p style="color: #666; line-height: 1.6;">Esta placa ya es tuya, pero a√∫n no has registrado los datos de tu mascota.</p>
        <a href="#" id="btn-activar-link" class="btn-activate">üêæ ACTIVAR MI PLACA AHORA</a>
    </div>
</div>

<div id="profile-view" class="profile-card" style="display: none;">
    <div id="lost-alert" class="lost-banner">üö® MASCOTA REPORTADA COMO EXTRAVIADA üö®</div>
    
    <div class="photo-container">
        <img id="pet-photo" src="" alt="Mascota">
        <div id="status-txt" class="status-badge">üõ°Ô∏è Protegido por Huellitas</div>
    </div>

    <div class="info-content">
        <h1 id="pet-name">Cargando...</h1>
        <span class="breed">Placa ID: <span id="display-id">---</span></span>
        
        <div class="emergency-box">
            <span style="color:#c53030; font-weight:bold; font-size:11px; text-transform:uppercase;">Mensaje:</span>
            <p id="pet-msg" style="margin: 5px 0 0; font-size: 15px;">Si me encuentras, por favor contacta a mi familia lo antes posible. ¬°Gracias!</p>
        </div>

        <div class="medical-box">
            <span style="color:#2c7a7b; font-weight:bold; font-size:11px; text-transform:uppercase;">Notas M√©dicas:</span>
            <p id="pet-medical" style="margin: 5px 0 0; font-size: 15px;">Sin observaciones.</p>
        </div>

        <div class="actions">
            <a href="#" id="call-link" class="btn btn-call">üìû Llamar al Due√±o</a>
            <a href="#" id="wa-link" class="btn btn-wa">üí¨ WhatsApp</a>
            
            <button id="btn-report-sighting" onclick="document.getElementById('file-report').click()" class="btn btn-report">
                üì∏ REPORTAR AVISTAMIENTO
            </button>
            <input type="file" id="file-report" accept="image/*" capture="camera" class="hidden" onchange="enviarAvistamiento(this)">
        </div>
    </div>

    <footer>
        <img src="assets/img/logo.png" width="30" style="filter: grayscale(1); opacity:0.5;"><br>
        <b>Huellitas Digitales</b><br>
        <button id="admin-btn" onclick="ownerAccess()" class="btn-owner hidden">‚öôÔ∏è GESTIONAR PERFIL</button>
    </footer>
</div>

<div id="floating-hub-menu" class="hidden" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
    <button onclick="window.location.href='hub.html'" style="background: var(--primary); color: white; border: none; width: 56px; height: 56px; border-radius: 28px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; border: 2px solid white;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
    </button>
    <span style="position: absolute; right: 65px; bottom: 12px; background: white; padding: 6px 12px; border-radius: 10px; font-size: 12px; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.1); white-space: nowrap; color: #555; border: 1px solid #eee; pointer-events: none;">Mi Panel</span>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    emailjs.init("TWeQlV3AV77UPCLZ6");

    const firebaseConfig = {
        apiKey: "AIzaSyCqROIzmp2guo2XLbdYrSW3ujlUBc7ngOc",
        authDomain: "huellitas-digitales.firebaseapp.com",
        projectId: "huellitas-digitales",
        storageBucket: "huellitas-digitales.firebasestorage.app",
        messagingSenderId: "523935942496",
        appId: "1:523935942496:web:0bb3ad3b28c189345fc005"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let petData = null;

    async function loadProfile() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        if (!id) return;

        const docRef = doc(db, "placas", id.toUpperCase());
        const docSnap = await getDoc(docRef);
        document.getElementById("loading-view").style.display = "none";

        if (docSnap.exists()) {
            const data = docSnap.data();
            petData = data;

            if (data.activa) {
                const idUpper = id.toUpperCase();
                
                // --- DETECCI√ìN DE DUE√ëO ---
                const currentUserEmail = localStorage.getItem("userEmail");
                const esDueno = currentUserEmail && currentUserEmail === data.email;

                if (esDueno) {
                    document.getElementById("admin-btn").classList.remove("hidden");
                    document.getElementById("floating-hub-menu").classList.remove("hidden");
                    // Opcional: Ocultar bot√≥n de avistamiento al due√±o
                    document.getElementById("btn-report-sighting").style.display = "none";
                }

                document.getElementById("pet-name").innerText = data.mascota;
                document.getElementById("display-id").innerText = idUpper;
                document.getElementById("pet-photo").src = data.foto || "assets/img/logo.png";
                if(data.mensaje) document.getElementById("pet-msg").innerText = data.mensaje;
                if(data.notas) document.getElementById("pet-medical").innerText = data.notas;
                
                if(data.extraviado) {
                    document.getElementById("lost-alert").style.display = "block";
                    document.getElementById("status-txt").innerText = "‚ö†Ô∏è BUSCANDO FAMILIA";
                    document.getElementById("status-txt").style.background = "var(--danger)";
                }

                document.getElementById("call-link").href = `tel:${data.telefono}`;
                document.getElementById("wa-link").href = `https://wa.me/${data.telefono.replace(/\D/g,'')}?text=Hola,%20encontr√©%20a%20tu%20mascota`;
                document.getElementById("profile-view").style.display = "block";

                // --- GEOLOCALIZACI√ìN INTELIGENTE ---
                if (navigator.geolocation && !esDueno) {
                    navigator.geolocation.getCurrentPosition((position) => {
                        const mapsUrl = `https://www.google.com/maps?q=${position.coords.latitude},${position.coords.longitude}`;
                        console.log("Visitante detectado. Enviando alerta...");
                        emailjs.send("service_xwx9czt", "template_rghvb1w", {
                            pet_name: data.mascota,
                            pet_id: idUpper,
                            map_url: mapsUrl,
                            owner_email: data.email,
                            mensaje_aviso: "Alguien ha escaneado la placa."
                        });
                    }, null, {timeout: 10000});
                }
            } else if (data.vendida) {
                document.getElementById("btn-activar-link").href = `index.html?id=${id.toUpperCase()}`;
                document.getElementById("not-active-view").style.display = "block";
            } else {
                document.getElementById("not-sold-view").style.display = "block";
            }
        } else {
            document.getElementById("not-sold-view").style.display = "block";
        }
    }

    // FUNCI√ìN DE REPORTE DE FOTO (Con guardado en BD)
    window.enviarAvistamiento = async (input) => {
        if (!input.files || !input.files[0]) return;
        
        const btn = document.querySelector('.btn-report');
        btn.innerText = "‚è≥ PROCESANDO...";
        btn.disabled = true;

        try {
            let lat = null, lon = null;
            if (navigator.geolocation) {
                const pos = await new Promise(resolve => navigator.geolocation.getCurrentPosition(resolve, () => resolve(null), {timeout: 5000}));
                if (pos) { lat = pos.coords.latitude; lon = pos.coords.longitude; }
            }

            const reader = new FileReader();
            reader.readAsDataURL(input.files[0]);
            reader.onload = async () => {
                await addDoc(collection(db, "avistamientos"), {
                    petId: new URLSearchParams(window.location.search).get('id').toUpperCase(),
                    foto: reader.result,
                    lat: lat, 
                    lon: lon,
                    fecha: serverTimestamp(),
                    vistoPor: "Anonimo"
                });

                const mapsUrl = lat ? `https://www.google.com/maps?q=${lat},${lon}` : "No compartida";
                await emailjs.send("service_xwx9czt", "template_rghvb1w", {
                    pet_name: petData.mascota,
                    owner_email: petData.email,
                    map_url: mapsUrl,
                    mensaje_aviso: "¬°URGENTE! Foto de avistamiento subida."
                });

                alert("‚úÖ Aviso enviado con √©xito.");
                btn.innerText = "üì∏ ENVIADO";
            };
        } catch (e) {
            console.error(e);
            alert("Error al enviar.");
            btn.disabled = false;
        }
    };

    window.ownerAccess = () => {
        const id = new URLSearchParams(window.location.search).get('id');
        window.location.href = `editar.html?id=${id}`;
    };

    loadProfile();
</script>
</body>
</html>
