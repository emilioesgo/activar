<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de Mascota | Huellitas Digitales</title>
    <link rel="icon" type="image/png" href="assets/img/favicon.png">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root { --primary: #2bb673; --whatsapp: #25D366; --bg: #f0f2f5; --text: #2c3e50; --medical: #e6fffa; --medical-border: #b2f5ea; --danger: #e53e3e; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; color: var(--text); }
        
        .profile-card { background: white; width: 100%; max-width: 450px; min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        /* Estilo si est√° extraviado */
        .is-lost { border: 5px solid var(--danger); }
        .lost-banner { display: none; background: var(--danger); color: white; text-align: center; padding: 10px; font-weight: bold; position: sticky; top: 0; z-index: 100; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .photo-container { width: 100%; height: 350px; background: #fff; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #pet-photo { width: 100%; height: 100%; object-fit: cover; }
        .img-logo-fallback { width: 60% !important; height: auto !important; object-fit: contain !important; opacity: 0.8; }
        
        .status-badge { position: absolute; bottom: 20px; left: 20px; background: var(--primary); color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 10; }

        .info-content { padding: 30px; border-radius: 30px 30px 0 0; background: white; margin-top: -30px; position: relative; z-index: 20; }
        h1 { margin: 0; font-size: 32px; }
        .breed { color: #888; font-size: 16px; margin-bottom: 20px; display: block; }

        .emergency-box { background: #fff5f5; border: 1px dashed #feb2b2; padding: 15px; border-radius: 15px; margin-bottom: 15px; }
        .emergency-box span { color: #c53030; font-weight: bold; font-size: 13px; display: block; margin-bottom: 5px; text-transform: uppercase; }

        .medical-box { background: var(--medical); border: 1px solid var(--medical-border); padding: 15px; border-radius: 15px; margin-bottom: 25px; }
        .medical-box span { color: #2c7a7b; font-weight: bold; font-size: 13px; display: block; margin-bottom: 5px; text-transform: uppercase; }

        .actions { display: grid; gap: 15px; }
        .btn { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 18px; border-radius: 15px; text-decoration: none; color: white; font-weight: bold; font-size: 18px; transition: 0.3s; }
        .btn-call { background: var(--primary); box-shadow: 0 5px 15px rgba(43,182,115,0.3); }
        .btn-wa { background: var(--whatsapp); box-shadow: 0 5px 15px rgba(37,211,102,0.3); }

        .status-container { text-align: center; padding: 60px 30px; }
        .btn-activate { background: var(--primary); color: white; padding: 20px; border-radius: 15px; text-decoration: none; font-weight: bold; display: block; font-size: 18px; margin-top: 25px; box-shadow: 0 5px 15px rgba(43,182,115,0.3); }

        footer { text-align: center; padding: 40px 20px; font-size: 12px; color: #aaa; background: #fafafa; border-top: 1px solid #eee; }
        .btn-owner { display: inline-block; background: #2c3e50; color: white; padding: 10px 20px; border-radius: 10px; text-decoration: none; font-weight: bold; margin-top: 15px; font-size: 14px; transition: 0.3s; border: none; cursor: pointer; }

        .loading { text-align: center; padding: 100px 20px; }
    </style>
</head>
<body>

<div id="loading-view" class="loading">
    <img src="assets/img/logo.png" width="80" style="margin-bottom: 20px; opacity: 0.5;">
    <p>Buscando informaci√≥n de la mascota...</p>
</div>

<div id="not-sold-view" class="profile-card" style="display: none;">
    <div class="status-container">
        <img src="assets/img/logo.png" width="100" style="margin-bottom: 30px;">
        <h2 style="color: var(--text);">Placa no disponible</h2>
        <p style="color: #666; line-height: 1.6;">Esta placa a√∫n no ha sido habilitada para su venta.</p>
    </div>
</div>

<div id="not-active-view" class="profile-card" style="display: none;">
    <div class="status-container">
        <img src="assets/img/logo.png" width="100" style="margin-bottom: 30px;">
        <h2 style="color: var(--text); margin-bottom: 10px;">¬°Placa Detectada!</h2>
        <p style="color: #666; line-height: 1.6;">Esta placa ya es tuya, pero a√∫n no has registrado los datos de tu mascota.</p>
        <a href="#" id="btn-activar-link" class="btn-activate">üêæ ACTIVAR MI PLACA AHORA</a>
    </div>
</div>

<div id="profile-view" class="profile-card" style="display: none;">
    <div id="lost-alert" class="lost-banner">üö® MASCOTA REPORTADA COMO EXTRAVIADA üö®</div>
    
    <div class="photo-container">
        <img id="pet-photo" src="" alt="Mascota">
        <div id="status-txt" class="status-badge">üõ°Ô∏è Protegido por Huellitas</div>
    </div>

    <div class="info-content">
        <h1 id="pet-name">Cargando...</h1>
        <span class="breed">Placa ID: <span id="display-id">---</span></span>
        
        <div class="emergency-box">
            <span id="label-mensaje">MENSAJE DE MI MASCOTA:</span>
            <p id="pet-msg" style="margin: 0; font-size: 15px;">Si me encuentras, por favor contacta a mi familia lo antes posible. ¬°Gracias!</p>
        </div>

        <div class="medical-box">
            <span>ü©∫ OBSERVACIONES Y NOTAS M√âDICAS:</span>
            <p id="pet-medical" style="margin: 0; font-size: 15px; color: #2d3748;">Sin observaciones registradas.</p>
        </div>

        <div class="actions">
            <a href="#" id="call-link" class="btn btn-call">üìû Llamar al Due√±o</a>
            <a href="#" id="wa-link" class="btn btn-wa">üí¨ Enviar WhatsApp</a>
        </div>
    </div>

    <footer>
        <img src="assets/img/logo.png" width="30" style="margin-bottom: 10px; filter: grayscale(1);"><br>
        <b>Huellitas Digitales</b><br>
        <button onclick="ownerAccess()" class="btn-owner">‚öôÔ∏è GESTIONAR MI PERFIL (DUE√ëO)</button>
    </footer>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    emailjs.init("TWeQlV3AV77UPCLZ6");

    const firebaseConfig = {
        apiKey: "AIzaSyCqROIzmp2guo2XLbdYrSW3ujlUBc7ngOc",
        authDomain: "huellitas-digitales.firebaseapp.com",
        projectId: "huellitas-digitales",
        storageBucket: "huellitas-digitales.firebasestorage.app",
        messagingSenderId: "523935942496",
        appId: "1:523935942496:web:0bb3ad3b28c189345fc005"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function loadProfile() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');

        if (!id) {
            document.body.innerHTML = "<h2 style='text-align:center; margin-top:50px;'>ID de placa no encontrado.</h2>";
            return;
        }

        try {
            const docRef = doc(db, "placas", id.toUpperCase());
            const docSnap = await getDoc(docRef);

            document.getElementById("loading-view").style.display = "none";

            if (docSnap.exists()) {
                const data = docSnap.data();

                if (data.activa) {
                    const idUpper = id.toUpperCase();
                    document.getElementById("pet-name").innerText = data.mascota;
                    document.getElementById("display-id").innerText = idUpper;
                    document.getElementById("label-mensaje").innerText = `MENSAJE DE ${data.mascota.toUpperCase()}:`;
                    
                    if(data.notas) document.getElementById("pet-medical").innerText = data.notas;
                    if(data.mensaje) document.getElementById("pet-msg").innerText = data.mensaje;

                    // L√≥gica de Foto
                    const imgElement = document.getElementById("pet-photo");
                    if(data.foto && data.foto !== "") {
                        imgElement.src = data.foto;
                    } else {
                        imgElement.src = "assets/img/logo.png";
                        imgElement.classList.add("img-logo-fallback");
                    }

                    // Modo Extrav√≠o Visual
                    if(data.extraviado) {
                        document.getElementById("lost-alert").style.display = "block";
                        document.getElementById("profile-view").classList.add("is-lost");
                        document.getElementById("status-txt").innerText = "‚ö†Ô∏è BUSCANDO FAMILIA";
                        document.getElementById("status-txt").style.background = "var(--danger)";
                    }

                    document.getElementById("call-link").href = `tel:${data.telefono}`;
                    document.getElementById("wa-link").href = `https://wa.me/${data.telefono.replace(/\+/g, '').replace(/\s/g, '')}?text=Hola,%20encontr√©%20a%20tu%20mascota%20${data.mascota}.`;

                    document.getElementById("profile-view").style.display = "block";

                    // --- GEOLOCALIZACI√ìN SILENCIOSA ---
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition((position) => {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            const mapsUrl = `https://www.google.com/maps?q=${lat},${lon}`;
                            
                            emailjs.send("service_xwx9czt", "template_rghvb1w", {
                                pet_name: data.mascota,
                                pet_id: idUpper,
                                map_url: mapsUrl,
                                owner_email: data.email
                            });
                        }, (err) => console.log("Geo bloqueada"), {timeout: 10000});
                    }

                } else if (data.vendida) {
                    document.getElementById("btn-activar-link").href = `index.html?id=${id.toUpperCase()}`;
                    document.getElementById("not-active-view").style.display = "block";
                } else {
                    document.getElementById("not-sold-view").style.display = "block";
                }
            } else {
                document.getElementById("not-sold-view").style.display = "block";
            }
        } catch (e) {
            console.error(e);
        }
    }

    window.ownerAccess = () => {
        const id = new URLSearchParams(window.location.search).get('id');
        window.location.href = `editar.html?id=${id}`;
    };

    loadProfile();
</script>
<div id="floating-hub-menu" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
    <button onclick="window.location.href='hub.html'" style="
        background: var(--primary, #2bb673); 
        color: white; 
        border: none; 
        width: 56px; 
        height: 56px; 
        border-radius: 28px; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
        cursor: pointer; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        transition: 0.3s;
        border: 2px solid white;
    " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
    </button>
    <span style="
        position: absolute; 
        right: 65px; 
        bottom: 12px; 
        background: white; 
        padding: 6px 12px; 
        border-radius: 10px; 
        font-size: 12px; 
        font-weight: bold; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        white-space: nowrap;
        color: #555;
        border: 1px solid #eee;
        pointer-events: none;
    ">Mi Panel</span>
</div>
</body>
</html>
