<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de Mascota | Huellitas Digitales</title>
    <style>
        :root { --primary: #2bb673; --whatsapp: #25D366; --bg: #f4f7f6; --text: #333; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 0; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 100%; max-width: 450px; overflow: hidden; text-align: center; }
        
        .foto-container { width: 100%; height: 300px; background: #eee; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .foto-container img { width: 100%; height: 100%; object-fit: cover; }
        
        .info-content { padding: 30px; }
        h1 { color: var(--primary); margin: 0 0 10px 0; font-size: 28px; }
        .badge-id { display: inline-block; background: #f0f0f0; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; color: #888; margin-bottom: 20px; }
        
        .mensaje-box { background: #fffde7; padding: 15px; border-radius: 15px; margin-bottom: 25px; border: 1px dashed #ffd54f; font-style: italic; color: #555; text-align: left; }
        .label { font-size: 12px; color: #999; text-transform: uppercase; font-weight: bold; }

        /* Botones de acci√≥n */
        .btn-action { text-decoration: none; padding: 16px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-bottom: 12px; transition: 0.3s; font-size: 16px; border: none; width: 100%; cursor: pointer; }
        
        .btn-call { background: var(--primary); color: white; }
        .btn-whatsapp { background: var(--whatsapp); color: white; }
        
        .btn-edit { background: transparent; color: #aaa; border: 1px solid #ddd; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 13px; margin-top: 30px; }
        
        #loading { padding: 50px; color: #999; }
        .hidden { display: none; }
        .icon { margin-right: 10px; font-size: 20px; }
    </style>
</head>
<body>

<div class="card">
    <div id="loading">‚åõ Cargando perfil del peludo...</div>

    <div id="perfil-content" class="hidden">
        <div class="foto-container">
            <img id="mascota-foto" src="" alt="Foto de la mascota">
        </div>

        <div class="info-content">
            <span id="placa-id" class="badge-id">ID: ----</span>
            <h1 id="mascota-nombre">Nombre</h1>
            
            <div id="mensaje-container" class="mensaje-box">
                <span class="label">Mensaje del due√±o:</span>
                <p id="mascota-msj" style="margin: 5px 0 0 0;">Cargando notas...</p>
            </div>

            <a id="btn-llamar" href="#" class="btn-action btn-call">
                <span class="icon">üìû</span> LLAMAR AL DUE√ëO
            </a>

            <a id="btn-whatsapp" href="#" target="_blank" class="btn-action btn-whatsapp">
                <span class="icon">üí¨</span> ENVIAR WHATSAPP
            </a>

            <button id="btn-ir-editar" class="btn-edit">‚öôÔ∏è Soy el due√±o, editar datos</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCqROIzmp2guo2XLbdYrSW3ujlUBc7ngOc",
        authDomain: "huellitas-digitales.firebaseapp.com",
        projectId: "huellitas-digitales",
        storageBucket: "huellitas-digitales.firebasestorage.app",
        messagingSenderId: "523935942496",
        appId: "1:523935942496:web:0bb3ad3b28c189345fc005"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const urlParams = new URLSearchParams(window.location.search);
    const placaId = urlParams.get('id') ? urlParams.get('id').toUpperCase() : null;

    async function cargarPerfil() {
        if (!placaId) {
            document.getElementById("loading").innerText = "‚ùå ID de placa no v√°lido.";
            return;
        }

        try {
            const docRef = doc(db, "placas", placaId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists() && docSnap.data().activa === true) {
                const datos = docSnap.data();

                // Llenar datos
                document.getElementById("placa-id").innerText = "ID: " + placaId;
                document.getElementById("mascota-nombre").innerText = datos.mascota;
                document.getElementById("mascota-msj").innerText = datos.mensaje || "Sin notas adicionales.";
                document.getElementById("mascota-foto").src = datos.foto || "https://via.placeholder.com/300?text=Sin+Foto";
                
                // Configurar Llamada
                document.getElementById("btn-llamar").href = "tel:" + datos.telefono;

                // Configurar WhatsApp con mensaje personalizado
                // Formato: https://wa.me/NUMERO?text=MENSAJE_CODIFICADO
                const nombreMascota = datos.mascota;
                const mensajeWa = `Hola, encontr√© a ${nombreMascota} üê∂üê±, cont√°ctame pronto.`;
                const mensajeEncoded = encodeURIComponent(mensajeWa);
                
                // Quitamos espacios o s√≠mbolos del tel√©fono para el link de WhatsApp
                const telLimpio = datos.telefono.replace(/\D/g,''); 
                document.getElementById("btn-whatsapp").href = `https://wa.me/${telLimpio}?text=${mensajeEncoded}`;

                // Mostrar contenido
                document.getElementById("loading").classList.add("hidden");
                document.getElementById("perfil-content").classList.remove("hidden");
            } else {
                document.getElementById("loading").innerText = "üêæ Esta placa a√∫n no ha sido activada.";
            }
        } catch (error) {
            console.error(error);
            document.getElementById("loading").innerText = "‚ùå Error al cargar los datos.";
        }
    }

    document.getElementById("btn-ir-editar").onclick = () => {
        window.location.href = `editar.html?id=${placaId}`;
    };

    cargarPerfil();
</script>
</body>
</html>
